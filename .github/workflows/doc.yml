name: Documentation Generation

on:
  push:
    branches: [develop]

jobs:
  Deploy-Doc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Install pipenv and dependencies
        run: |
          python -m pip install pipenv
          python -m pipenv install --dev
      - name: Fetch Taipy Core code
        uses: actions/checkout@v2
        with:
          repository: Avaiga/taipy-core
          ref: develop
          path: taipy-core
          token: ${{ secrets.TAIPY_REPOS_ACCESS_TOKEN }}
      - name: Save Taipy Core code
        run: |
          mv taipy-core/taipy .
          rm -rf taipy-core
      - name: Fetch Taipy Gui code and elements doc
        uses: actions/checkout@v2
        with:
          repository: Avaiga/taipy-gui
          ref: develop
          path: taipy-gui
          token: ${{ secrets.TAIPY_REPOS_ACCESS_TOKEN }}
      - name: Save Taipy Gui code
        run: |
          (cd taipy-gui;tar cf - taipy gui)|tar xf -
          rm -rf taipy-gui
      - name: Create Taipy __init__ file
        run: |
          echo "from taipy.core import *" >taipy/__init__.py
          echo "import taipy.gui as gui" >>taipy/__init__.py
      - name: Fetch Taipy Getting Started code
        uses: actions/checkout@v2
        with:
          repository: Avaiga/taipy-getting-started
          ref: develop
          path: taipy-getting-started
          token: ${{ secrets.TAIPY_REPOS_ACCESS_TOKEN }}
      - name: Add the Getting Started steps and README in content of the doc
        run: |
          mv taipy-getting-started/step_* docs/getting_started/
          mv taipy-getting-started/README.md docs/getting_started/index.md
      - name: Pre-process root package and GUI doc
        run: |
          pipenv run python tools/setup_generation.py
      - name: Build doc and deploy
        run: |
          pipenv run mkdocs gh-deploy --force
